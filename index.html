<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Calendário de Residência Médica — Lista Completa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }
    
    .header .logo {
      height: 22px;
      width: auto;
      object-fit: contain;
    }
    
    @media (max-width: 600px){
      .header .logo { height: 44px; }
    }
    
    :root { --border:#ddd; --bg:#f6f6f6; --fg:#222; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--fg); margin: 24px; }
    h1 { margin: 0 0 10px; font-size: clamp(22px, 4vw, 40px); }
    .sub { margin: 6px 0 18px; opacity: .85; }
    table { width: 100%; border-collapse: collapse; }
    thead th { background: var(--bg); }
    th, td { border: 1px solid var(--border); padding: 10px 12px; text-align: left; vertical-align: top; }
    tbody tr:nth-child(even){ background: #fafafa; }
    .nowrap { white-space: nowrap; }
    .muted { opacity:.8; }

    /* Filtro */
    .filters-wrap { display:flex; align-items:center; gap:10px; margin: 6px 0 14px; flex-wrap: wrap; }
    .filter-title { font-weight:600; }
    .dropdown { position: relative; display: inline-block; }
    .btn { cursor: pointer; padding: 8px 12px; border: 1px solid var(--border); background:#fff; border-radius:8px; }
    .panel {
      position: absolute; top: 42px; left: 0; min-width: 260px; max-height: 320px; overflow:auto;
      border: 1px solid var(--border); background:#fff; border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,.08); display:none; z-index: 20;
    }
    .panel.open { display:block; }
    .panel .row { display:flex; align-items:center; gap:8px; padding:8px 10px; }
    .panel .row:hover { background:#f8f8f8; }
    .panel .actions { display:flex; gap:8px; padding:8px 10px; border-top:1px solid var(--border); position:sticky; bottom:0; background:#fff; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#fff; font-size: 12px; }
    .chip button { border:none; background:transparent; cursor:pointer; font-size:12px; }
  </style>
</head>
<body>
  <div class="header">
  <h2>Calendário de Residência Médica — Lista Completa:</h2>

  <a href="https://educacaomedica.afya.com.br/" target="_blank" rel="noopener"
     aria-label="Abrir site Afya Educação Médica">
    <img src="afya.png" alt="Afya Educação Médica" class="logo">
  </a>
</div>

  <p id="last-update" class="sub">Atualizado em --/--/---- --:--</p>

  <div class="filters-wrap">
    <span class="filter-title">Provas no mês:</span>
    <div class="dropdown" id="monthFilter">
      <button class="btn" id="togglePanel">Selecionar mês/ano</button>
      <div class="panel" id="panel">
        <div class="actions">
          <button class="btn" id="btnClear">Limpar</button>
          <button class="btn" id="btnClose">Fechar</button>
        </div>
        <!-- opções geradas via JS -->
      </div>
    </div>
    <div id="activeChips"></div>

    <!-- NOVO: botão exportar -->
    <button class="btn" id="btnExport">Gerar Excel</button>
  </div>

  <table id="tabela-calendario" aria-describedby="last-update">
    <thead>
      <tr>
        <th class="nowrap">UF</th>
        <th>INSTITUIÇÃO</th>
        <th class="nowrap">INSCRIÇÕES</th>
        <th class="nowrap">PROVA OBJETIVA</th>
        <th class="nowrap">GABARITO PRELIMINAR</th>
        <th class="nowrap">RESULTADO FINAL</th>
      </tr>
    </thead>
    <tbody><!-- preenchido via JS --></tbody>
  </table>

  <script>
    if (!window.__CAL_TAB_INIT__) {
      window.__CAL_TAB_INIT__ = true;

      const PT_BR_MONTHS = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
      const DATE_RE = /\b(\d{2})\/(\d{2})\/(\d{4})\b/; // primeira data dd/mm/aaaa

      const state = {
        allRows: [],              // dados completos
        activeMonths: new Set(),  // chaves 'YYYY-MM' selecionadas
        monthIndex: []            // lista [{key:'YYYY-MM', label:'MMM - YYYY'}]
      };

      function baseUrl(path){
        const base = new URL('.', window.location.href);
        return new URL(path, base).toString();
      }

      function getMonthKeyFromText(txt){
        const m = (txt||"").match(DATE_RE);
        if (!m) return null;
        const dd = m[1], mm = m[2], yyyy = m[3];
        return `${yyyy}-${mm}`;
      }
      function keyToLabel(key){ // 'YYYY-MM' -> 'MMM - YYYY'
        const [y, mm] = key.split("-");
        const mIdx = parseInt(mm,10)-1;
        const mLabel = PT_BR_MONTHS[mIdx] || mm;
        return `${mLabel} - ${y}`;
      }

      function buildMonthIndex(data){
        const set = new Set();
        data.forEach(r=>{
          const k = getMonthKeyFromText(r["PROVA_OBJETIVA"]);
          if (k) set.add(k);
        });
        const arr = Array.from(set).sort((a,b)=> a.localeCompare(b)); // 'YYYY-MM' ordena corretamente
        state.monthIndex = arr.map(k=>({key:k, label:keyToLabel(k)}));
      }

      async function loadLastUpdate(){
        try{
          const resp = await fetch(baseUrl('data/meta.json'), { cache: 'no-store' });
          if (!resp.ok) return;
          const meta = await resp.json();
          if (meta.last_update_brt){
            document.getElementById('last-update').textContent = `Atualizado em ${meta.last_update_brt}`;
          }
        }catch(e){}
      }

      async function fetchDados(){
        const resp = await fetch(baseUrl('data/calendario_residencia.json'), { cache: 'no-store' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const dados = await resp.json();
        state.allRows = Array.isArray(dados) ? dados : [];
        buildMonthIndex(state.allRows);
      }

      function shouldShow(row){
        if (state.activeMonths.size === 0) return true;
        const k = getMonthKeyFromText(row["PROVA_OBJETIVA"]);
        return k && state.activeMonths.has(k);
      }

      function renderTable(){
        const tbody = document.querySelector('#tabela-calendario tbody');
        while (tbody.firstChild) tbody.removeChild(tbody.firstChild);

        const seen = new Set(); // dedupe defensivo
        const key = r => [
          (r.UF||'').toUpperCase(),
          (r['INSTITUIÇÃO']||'').toUpperCase(),
          (r['INSCRIÇÕES']||'').trim(),
          (r['PROVA_OBJETIVA']||'').trim(),
          (r['GABARITO_PRELIMINAR']||'').trim(),
          (r['RESULTADO_FINAL']||'').trim(),
        ].join(' | ');

        let count = 0;
        for (const item of state.allRows){
          if (!shouldShow(item)) continue;
          const k = key(item);
          if (seen.has(k)) continue;
          seen.add(k);

          const tr = document.createElement('tr');
          const cells = [
            item.UF || '',
            item['INSTITUIÇÃO'] || '',
            item['INSCRIÇÕES'] || '',
            item['PROVA_OBJETIVA'] || '',
            item['GABARITO_PRELIMINAR'] || '-',
            item['RESULTADO_FINAL'] || '-',
          ];
          for (const val of cells){
            const td = document.createElement('td');
            td.textContent = val;
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
          count++;
        }
        if (count === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className = 'muted';
          td.textContent = 'Sem registros para o(s) filtro(s) selecionado(s).';
          tr.appendChild(td);
          tbody.appendChild(tr);
        }
      }

      function renderFilterPanel(){
        const panel = document.getElementById('panel');
        panel.querySelectorAll('.row.opt').forEach(n=>n.remove());

        state.monthIndex.forEach(({key,label})=>{
          const row = document.createElement('label');
          row.className = 'row opt';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = state.activeMonths.has(key);
          cb.addEventListener('change', ()=>{
            if (cb.checked) state.activeMonths.add(key);
            else state.activeMonths.delete(key);
            renderActiveChips();
            renderTable();
          });
          const span = document.createElement('span');
          span.textContent = label;
          row.appendChild(cb);
          row.appendChild(span);
          panel.insertBefore(row, panel.firstChild.nextSibling);
        });
      }

      function renderActiveChips(){
        const wrap = document.getElementById('activeChips');
        wrap.innerHTML = '';
        if (state.activeMonths.size === 0) return;
        Array.from(state.activeMonths).sort().forEach(k=>{
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = keyToLabel(k);
          const btn = document.createElement('button');
          btn.textContent = '×';
          btn.title = 'Remover filtro';
          btn.onclick = ()=>{ state.activeMonths.delete(k); renderActiveChips(); renderTable(); };
          chip.appendChild(btn);
          wrap.appendChild(chip);
        });
      }

      function bindFilterUI(){
        const dd = document.getElementById('monthFilter');
        const panel = document.getElementById('panel');
        const btn = document.getElementById('togglePanel');
        const btnClear = document.getElementById('btnClear');
        const btnClose = document.getElementById('btnClose');

        btn.onclick = ()=> panel.classList.toggle('open');
        btnClose.onclick = ()=> panel.classList.remove('open');
        btnClear.onclick = ()=>{
          state.activeMonths.clear();
          renderActiveChips();
          renderTable();
          panel.classList.remove('open');
        };
        document.addEventListener('click', (e)=>{
          if (!dd.contains(e.target)) panel.classList.remove('open');
        });

        renderFilterPanel();
      }

      // -------- Exportação (CSV que abre no Excel) --------
      function getFilteredRows(){
        const out = [];
        const seen = new Set();
        const key = r => [
          (r.UF||'').toUpperCase(),
          (r['INSTITUIÇÃO']||'').toUpperCase(),
          (r['INSCRIÇÕES']||'').trim(),
          (r['PROVA_OBJETIVA']||'').trim(),
          (r['GABARITO_PRELIMINAR']||'').trim(),
          (r['RESULTADO_FINAL']||'').trim(),
        ].join(' | ');
        for (const item of state.allRows){
          if (!shouldShow(item)) continue;
          const k = key(item);
          if (seen.has(k)) continue;
          seen.add(k);
          out.push(item);
        }
        return out;
      }

      function toCSV(rows){
        const headers = ["UF","INSTITUIÇÃO","INSCRIÇÕES","PROVA OBJETIVA","GABARITO PRELIMINAR","RESULTADO FINAL"];
        const sep = ";"; // amigável ao Excel BR
        const esc = v => {
          const s = (v==null ? "" : String(v));
          // escapa aspas
          const ss = s.replace(/"/g,'""');
          return `"${ss}"`;
        };
        const lines = [];
        lines.push(headers.map(esc).join(sep));
        for (const r of rows){
          lines.push([
            esc(r.UF||""),
            esc(r["INSTITUIÇÃO"]||""),
            esc(r["INSCRIÇÕES"]||""),
            esc(r["PROVA_OBJETIVA"]||""),
            esc(r["GABARITO_PRELIMINAR"]||"-"),
            esc(r["RESULTADO_FINAL"]||"-"),
          ].join(sep));
        }
        // BOM para Excel entender UTF-8
        const bom = "\ufeff";
        return bom + lines.join("\r\n");
      }

      function downloadCSV(csvText){
        const now = new Date();
        const pad = n => String(n).padStart(2,"0");
        const filename = `calendario_residencia_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.csv`;
        const blob = new Blob([csvText], {type: "text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
      }

      function bindExport(){
        document.getElementById('btnExport').onclick = ()=>{
          const rows = getFilteredRows();
          if (rows.length === 0){
            alert("Nenhum registro para exportar com o filtro atual.");
            return;
          }
          const csv = toCSV(rows);
          downloadCSV(csv);
        };
      }
      // ----------------------------------------------------

      (async function init(){
        await loadLastUpdate();
        await fetchDados();
        bindFilterUI();
        bindExport();
        renderActiveChips();
        renderTable();
      })();
    }
  </script>
</body>
</html>
